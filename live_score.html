<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Score - We Are Eleven</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #1e293b;
    }

    .section-header { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
    .section-header::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #64748b, transparent); animation: shimmer 3s infinite; }
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }

    .match-card { background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%); border: 1px solid #e5e7eb; transition: all 0.2s ease; }
    .match-card:hover { border-color: #d1d5db; transform: translateY(-2px); }

    .vs-text { font-weight: 800; color: #64748b; text-shadow: 0 1px 2px rgb(0 0 0 / 0.1); }
    .team-name { font-weight: 600; color: #111827; text-align: center; font-size: 1rem; margin-top: 0.25rem; }

    .scoreline-badge { display:inline-block; padding:0.25rem 0.75rem; border-radius:9999px; background:linear-gradient(135deg,#111827,#1f2937); color:#fff; font-weight:700; box-shadow:0 2px 6px rgb(0 0 0 / 0.2); letter-spacing:0.5px }
    .status-badge { display:inline-block; padding:0.15rem 0.5rem; border-radius:9999px; font-weight:700; font-size:0.75rem; margin-left:0.5rem }
    .status-live { background:#dc2626; color:#fff; animation:pulse 1.8s infinite; }
    .status-ht { background:#f59e0b; color:#111827; }
    .status-ft { background:#6b7280; color:#fff; }
    @keyframes pulse { 0%{ box-shadow:0 0 0 0 rgba(220,38,38,.6) } 70%{ box-shadow:0 0 0 8px rgba(220,38,38,0) } 100%{ box-shadow:0 0 0 0 rgba(220,38,38,0) } }

    .scorer-list { font-size:0.9rem; line-height:1.2; }
    .scorer-item { display:flex; align-items:flex-start; gap:0.5rem; }
    .scorer-bullet { font-size:0.9rem; opacity:0.6 }
    .muted { color:#6b7280 }

    .badge { display:inline-flex; align-items:center; gap:.35rem; font-weight:600; font-size:.75rem; padding:.25rem .6rem; border-radius:9999px; border:1px solid #e2e8f0; background:#f1f5f9; color:#0f172a; }

    .knockout-card { background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; transition: all 0.3s ease; }
    .knockout-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgb(0 0 0 / 0.1); }

    .final-card { background: linear-gradient(145deg, #fffbeb 0%, #fef3c7 100%); border: 2px solid #fbbf24; position: relative; }
    .final-card::before { content: 'üëë'; position: absolute; top: -10px; right: -10px; font-size: 1.5rem; background: #fbbf24; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <div id="site-header"></div>

  <!-- Main Content -->
  <main class="flex-grow max-w-7xl mx-auto p-6 space-y-12">

    <!-- Live Scores -->
    <section class="section-header rounded-2xl shadow-lg p-8">
      <div class="flex items-center justify-between flex-wrap gap-3 mb-6">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">üì° Live Scores</h2>
          <p class="text-gray-600 text-sm">Realtime match updates with scorers & assisters.</p>
        </div>
        <div id="liveMeta" class="flex items-center gap-2 text-xs"></div>
      </div>

      <div id="matchesHost" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
    </section>

    <!-- Group Standings -->
    <section class="section-header rounded-2xl shadow-lg p-8">
      <div class="flex items-center justify-between flex-wrap gap-3 mb-6">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">üìä Group Standings</h2>
          <p class="text-gray-600 text-sm">Auto-calculated from finished group matches.</p>
        </div>
        <div id="standingsMeta" class="flex items-center gap-2 text-xs"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Group A -->
        <div class="rounded-2xl border border-slate-200 overflow-hidden">
          <div class="bg-slate-100 px-4 py-2 font-semibold text-slate-700 flex items-center justify-between">
            <span>Group A</span>
            <span id="gaStatus" class="badge">Awaiting matches‚Ä¶</span>
          </div>
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-700">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Team</th>
                <th class="px-3 py-2 text-right">P</th>
                <th class="px-3 py-2 text-right">W</th>
                <th class="px-3 py-2 text-right">D</th>
                <th class="px-3 py-2 text-right">L</th>
                <th class="px-3 py-2 text-right">GF</th>
                <th class="px-3 py-2 text-right">GA</th>
                <th class="px-3 py-2 text-right">GD</th>
                <th class="px-3 py-2 text-right">Pts</th>
              </tr>
            </thead>
            <tbody id="groupATbody" class="divide-y divide-slate-200 bg-white"></tbody>
          </table>
        </div>

        <!-- Group B -->
        <div class="rounded-2xl border border-slate-200 overflow-hidden">
          <div class="bg-slate-100 px-4 py-2 font-semibold text-slate-700 flex items-center justify-between">
            <span>Group B</span>
            <span id="gbStatus" class="badge">Awaiting matches‚Ä¶</span>
          </div>
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-700">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Team</th>
                <th class="px-3 py-2 text-right">P</th>
                <th class="px-3 py-2 text-right">W</th>
                <th class="px-3 py-2 text-right">D</th>
                <th class="px-3 py-2 text-right">L</th>
                <th class="px-3 py-2 text-right">GF</th>
                <th class="px-3 py-2 text-right">GA</th>
                <th class="px-3 py-2 text-right">GD</th>
                <th class="px-3 py-2 text-right">Pts</th>
              </tr>
            </thead>
            <tbody id="groupBTbody" class="divide-y divide-slate-200 bg-white"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Knockout Stage (auto from standings & SF results) -->
    <section class="section-header rounded-2xl shadow-lg p-8">
      <div class="text-center mb-10">
        <h2 class="text-4xl font-bold text-gray-900 mb-2"><span class="section-icon">üèÜ</span>Knockout Stage</h2>
        <p class="text-gray-600 text-lg">Auto-updates after all group matches finish.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 max-w-6xl mx-auto">
        <div class="knockout-card rounded-2xl shadow-md p-6">
          <div class="text-center mb-6">
            <h4 class="text-xl font-bold text-gray-800 mb-2">Semi Final 1</h4>
            <div class="w-12 h-0.5 bg-gradient-to-r from-transparent via-blue-400 to-transparent mx-auto"></div>
          </div>
          <div class="flex flex-col items-center gap-4" id="sf1Slot">
            <div class="text-sm text-gray-600">Winner Group A</div>
            <span class="vs-text text-lg">VS</span>
            <div class="text-sm text-gray-600">Runner-up Group B</div>
          </div>
        </div>

        <div class="knockout-card rounded-2xl shadow-md p-6">
          <div class="text-center mb-6">
            <h4 class="text-xl font-bold text-gray-800 mb-2">Semi Final 2</h4>
            <div class="w-12 h-0.5 bg-gradient-to-r from-transparent via-blue-400 to-transparent mx-auto"></div>
          </div>
          <div class="flex flex-col items-center gap-4" id="sf2Slot">
            <div class="text-sm text-gray-600">Winner Group B</div>
            <span class="vs-text text-lg">VS</span>
            <div class="text-sm text-gray-600">Runner-up Group A</div>
          </div>
        </div>

        <div class="knockout-card rounded-2xl shadow-md p-6">
          <div class="text-center mb-6">
            <h4 class="text-xl font-bold text-gray-800 mb-2">Third Place</h4>
            <div class="w-12 h-0.5 bg-gradient-to-r from-transparent via-orange-400 to-transparent mx-auto"></div>
          </div>
          <div class="flex flex-col items-center gap-4" id="thirdSlot">
            <div class="text-sm text-gray-600">Loser Semi Final 1</div>
            <span class="vs-text text-lg">VS</span>
            <div class="text-sm text-gray-600">Loser Semi Final 2</div>
          </div>
        </div>

        <div class="final-card rounded-2xl shadow-lg p-6">
          <div class="text-center mb-6">
            <h4 class="text-xl font-bold text-amber-800 mb-2">Championship Final</h4>
            <div class="w-12 h-0.5 bg-gradient-to-r from-transparent via-amber-500 to-transparent mx-auto"></div>
          </div>
          <div class="flex flex-col items-center gap-4" id="finalSlot">
            <div class="text-sm font-semibold text-amber-700">Winner SF1</div>
            <span class="vs-text text-xl text-amber-600">VS</span>
            <div class="text-sm font-semibold text-amber-700">Winner SF2</div>
          </div>
        </div>
      </div>
      <div class="text-center mt-4 text-sm text-slate-500" id="knockoutNote"></div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-gray-950 py-8 text-center text-gray-400 mt-12">
    <div class="max-w-4xl mx-auto px-4">
      <p class="text-lg">¬© 2025 Football Community. All Rights Reserved.</p>
      <p class="text-sm mt-2 opacity-75">Bringing together the best in football competition</p>
    </div>
  </footer>

  <!-- Header + teams -->
  <script type="module">
    import { injectHeader } from "./tournament_header.js";
    import { loadTeams, hydrateTeamLogos } from "./teams-util.js";
    injectHeader("#site-header", { active: "fixtures" }); // reuse style
    try { const maps = await loadTeams(); hydrateTeamLogos(document, maps); } catch (e) { console.warn("Teams JSON load failed:", e); }
  </script>

  <!-- Live Score logic -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { loadTeams } from "./teams-util.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0DaaYB1hZLY8h23QOpT7Ok4sX5ACkHTM",
      authDomain: "we-are-eleven.firebaseapp.com",
      projectId: "we-are-eleven",
      storageBucket: "we-are-eleven.firebasestorage.app",
      messagingSenderId: "446706356039",
      appId: "1:446706356039:web:db1bd26c20a2571b824662",
      measurementId: "G-M3DSVHMNEV"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const els = {
      matchesHost: document.getElementById('matchesHost'),
      liveMeta: document.getElementById('liveMeta'),
      gaBody: document.getElementById('groupATbody'),
      gbBody: document.getElementById('groupBTbody'),
      gaStatus: document.getElementById('gaStatus'),
      gbStatus: document.getElementById('gbStatus'),
      standingsMeta: document.getElementById('standingsMeta'),
      sf1: document.getElementById('sf1Slot'),
      sf2: document.getElementById('sf2Slot'),
      third: document.getElementById('thirdSlot'),
      final: document.getElementById('finalSlot'),
      knockoutNote: document.getElementById('knockoutNote'),
    };

    // ===== Helpers
    const esc = s => String(s ?? "").replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const norm = s => (s || "").toString().trim().toLowerCase();

    function toDate(ts){
      if(!ts) return null;
      if(typeof ts === 'number') return new Date(ts);
      if(typeof ts === 'object' && typeof ts.seconds === 'number') return new Date(ts.seconds*1000);
      return null;
    }
    function tsToMs(ts){ const d = toDate(ts); return d ? d.getTime() : null; }

    // 8 + 8 mins: goal minute display (adds 8' base for second half)
    function minuteStr(goalTime, doc){
      const t = tsToMs(goalTime);
      const ko = tsToMs(doc?.kickoff);
      const h2 = tsToMs(doc?.secondHalfStart);
      if (t && ko){
        if (h2 && t >= h2){
          const mins = 8 + Math.max(0, Math.floor((t - h2) / 60000));
          return `${mins}‚Äô`;
        }
        const mins = Math.max(0, Math.floor((t - ko) / 60000));
        return `${mins}‚Äô`;
      }
      return toDate(goalTime) ? toDate(goalTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
    }

    // tolerant LIVE/HT/FT logic (works with status OR timestamps you set from the scoreboard page)
    function computeStatus(doc){
      const s = (doc.status || "").toLowerCase();
      const ko  = toDate(doc.kickoff);
      const h1e = toDate(doc.firstHalfEnd);
      const h2s = toDate(doc.secondHalfStart);
      const ft  = toDate(doc.fulltime);

      if (s === 'ft' || doc.fulltime === true || ft) return { text:'FT', cls:'status-badge status-ft' };
      if (s === 'ht' || (h1e && !h2s))               return { text:'HT', cls:'status-badge status-ht' };
      if (s === 'live')                               return { text:'LIVE', cls:'status-badge status-live' };

      if (h2s && !ft) return { text:'LIVE', cls:'status-badge status-live' };
      if (h1e && !h2s) return { text:'HT',   cls:'status-badge status-ht' };
      if (ko && !h1e)  return { text:'LIVE', cls:'status-badge status-live' };

      return null;
    }

    function matchScore(doc){
      const s1 = (typeof doc?.scores?.team1 === 'number') ? doc.scores.team1 : null;
      const s2 = (typeof doc?.scores?.team2 === 'number') ? doc.scores.team2 : null;
      return (s1==null || s2==null) ? null : { s1, s2 };
    }

    // ===== Load teams + group mapping (use teams-util if available; otherwise fallback)
    let TEAM_TO_GROUP = new Map();    // normalized name -> 'A' | 'B'
    let NAME_BY_NORM  = new Map();    // normalized name -> original display name

    try {
      const maps = await loadTeams(); // optional: if your teams JSON includes { group }
      if (maps?.byName && typeof maps.byName.get === 'function') {
        maps.byName.forEach((meta, name) => {
          if (meta?.group) {
            const g = String(meta.group).toUpperCase();
            const n = norm(name);
            TEAM_TO_GROUP.set(n, g);
            NAME_BY_NORM.set(n, name);
          }
        });
      }
      if (maps?.teams && typeof maps.teams === 'object') {
        Object.entries(maps.teams).forEach(([name, meta]) => {
          if (meta?.group) {
            const g = String(meta.group).toUpperCase();
            const n = norm(name);
            TEAM_TO_GROUP.set(n, g);
            NAME_BY_NORM.set(n, name);
          }
        });
      }
    } catch(e) {
      console.warn('Could not load team groups from teams-util.js', e);
    }

    // --- REQUIRED FALLBACK: your confirmed groups ---
    const DEFAULT_GROUPS = {
      "Thunderbolt": "A",
      "Messiah FC": "A",
      "White Panthers": "A",
      "Amigos FC": "B",
      "Strawhat Pirates": "B",
      "Red Bulls Eleven": "B"
    };
    for (const [team, grp] of Object.entries(DEFAULT_GROUPS)) {
      const n = norm(team);
      if (!TEAM_TO_GROUP.has(n)) TEAM_TO_GROUP.set(n, grp);
      if (!NAME_BY_NORM.has(n))  NAME_BY_NORM.set(n, team);
    }

    const getGroup    = (teamName) => TEAM_TO_GROUP.get(norm(teamName)) || null;
    const displayName = (teamName) => NAME_BY_NORM.get(norm(teamName)) || teamName;

    // ===== Render match cards
    function renderMatchCard(d){
      const t1 = d.teamNames?.team1 || 'Team A';
      const t2 = d.teamNames?.team2 || 'Team B';
      const score = matchScore(d);
      const status = computeStatus(d);
      const goals = Array.isArray(d.goals) ? d.goals : [];

      const gs1 = [], gs2 = [];
      goals.forEach(g=>{
        const side = (g.team === 'team2') ? 'team2' : 'team1';
        const who = g.scorer || '';
        const ast = g.assist ? ` (${g.assist})` : '';
        const m = minuteStr(g.time, d);
        const label = [esc(who + ast), m].filter(Boolean).join(' ');
        if (!who) return;
        if (side==='team1') gs1.push(label); else gs2.push(label);
      });

      const div = document.createElement('div');
      div.className = 'match-card rounded-xl shadow-md p-6';
      div.innerHTML = `
        <div class="flex items-center justify-center gap-6">
          <div class="flex flex-col items-center">
            <span class="team-name">${esc(t1)}</span>
          </div>
          <div class="text-center">
            ${
              score
                ? `<span class="scoreline-badge">${score.s1} ‚Äì ${score.s2}</span>`
                : `<span class="scoreline-badge">VS</span>`
            }
            ${status ? ` <span class="${status.cls}">${status.text}</span>` : ''}
          </div>
          <div class="flex flex-col items-center">
            <span class="team-name">${esc(t2)}</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
          <div>
            <div class="text-xs font-semibold text-slate-500 mb-1">Scorers</div>
            <div class="scorer-list">
              ${gs1.length ? gs1.map(n=>`<div class="scorer-item"><span class="scorer-bullet">‚Ä¢</span><span>${n}</span></div>`).join('') : `<div class='muted'>‚Äî</div>`}
            </div>
          </div>
          <div>
            <div class="text-xs font-semibold text-slate-500 mb-1">Scorers</div>
            <div class="scorer-list">
              ${gs2.length ? gs2.map(n=>`<div class="scorer-item"><span class="scorer-bullet">‚Ä¢</span><span>${n}</span></div>`).join('') : `<div class='muted'>‚Äî</div>`}
            </div>
          </div>
        </div>
      `;
      return div;
    }

    function renderMatchList(matches){
      els.matchesHost.innerHTML = '';
      matches.forEach(docSnap=>{
        const d = docSnap.data() || {};
        els.matchesHost.appendChild(renderMatchCard(d));
      });
      els.liveMeta.innerHTML = `<span class="badge">Showing ${matches.length} matches</span>`;
    }

    // ===== Standings
    function emptyStats() { return { P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,Pts:0 }; }
    function addResult(stats, gf, ga){
      stats.P += 1; stats.GF += gf; stats.GA += ga; stats.GD = stats.GF - stats.GA;
      if (gf>ga){ stats.W+=1; stats.Pts+=3; } else if (gf===ga){ stats.D+=1; stats.Pts+=1; } else { stats.L+=1; }
    }

    function groupSetsFromMapping(){
      const A = new Set(), B = new Set();
      TEAM_TO_GROUP.forEach((g, nName) => { if (g==='A') A.add(nName); if (g==='B') B.add(nName); });
      return { A, B };
    }

    function buildStandings(matches){
      // seed all teams
      const { A:setA, B:setB } = groupSetsFromMapping();
      const table = { A:new Map(), B:new Map() };

      setA.forEach(nm => table.A.set(displayName(nm), emptyStats()));
      setB.forEach(nm => table.B.set(displayName(nm), emptyStats()));

      // aggregate only FT matches where both teams are in the same group
      matches.forEach(docSnap=>{
        const d = docSnap.data() || {};
        const t1 = (d.teamNames?.team1 || '').trim();
        const t2 = (d.teamNames?.team2 || '').trim();
        if (!t1 || !t2) return;

        const g1 = getGroup(t1);
        const g2 = getGroup(t2);
        if (!g1 || !g2 || g1 !== g2) return;

        const status = computeStatus(d);
        const s1 = (typeof d?.scores?.team1 === 'number') ? d.scores.team1 : null;
        const s2 = (typeof d?.scores?.team2 === 'number') ? d.scores.team2 : null;
        if (!status || status.text !== 'FT' || s1==null || s2==null) return;

        const g = g1; // "A" or "B"
        const map = table[g];

        const dn1 = displayName(t1);
        const dn2 = displayName(t2);
        if (!map.has(dn1)) map.set(dn1, emptyStats());
        if (!map.has(dn2)) map.set(dn2, emptyStats());

        addResult(map.get(dn1), s1, s2);
        addResult(map.get(dn2), s2, s1);
      });

      return { table, groupRoster: groupSetsFromMapping() };
    }

    function sortRows(map){
      const rows = [];
      map.forEach((v,k)=> rows.push({ team:k, ...v }));
      rows.sort((a,b)=> b.Pts - a.Pts || b.GD - a.GD || b.GF - a.GF || a.team.localeCompare(b.team));
      return rows;
    }

    function requiredMatchesFor(groupSet){
      const n = groupSet.size;
      return n * (n - 1) / 2; // each pair once
    }

    function renderStandingsCell(tbody, rows){
      tbody.innerHTML = '';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 text-slate-500">${i+1}</td>
          <td class="px-3 py-2">${esc(r.team)}</td>
          <td class="px-3 py-2 text-right">${r.P}</td>
          <td class="px-3 py-2 text-right">${r.W}</td>
          <td class="px-3 py-2 text-right">${r.D}</td>
          <td class="px-3 py-2 text-right">${r.L}</td>
          <td class="px-3 py-2 text-right">${r.GF}</td>
          <td class="px-3 py-2 text-right">${r.GA}</td>
          <td class="px-3 py-2 text-right">${r.GD}</td>
          <td class="px-3 py-2 text-right font-semibold">${r.Pts}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function countGroupFT(docs, groupLetter){
      let c = 0;
      docs.forEach(d=>{
        const data = d.data() || {};
        const t1 = (data.teamNames?.team1 || '').trim();
        const t2 = (data.teamNames?.team2 || '').trim();
        const g1 = getGroup(t1), g2 = getGroup(t2);
        const status = computeStatus(data);
        const s1 = (typeof data?.scores?.team1 === 'number') ? data.scores.team1 : null;
        const s2 = (typeof data?.scores?.team2 === 'number') ? data.scores.team2 : null;
        if (g1===groupLetter && g2===groupLetter && status && status.text==='FT' && s1!=null && s2!=null) c++;
      });
      return c;
    }

    // ===== Knockout logic
    function updateKnockouts(rowsA, rowsB, matches){
      const winnerA = rowsA[0]?.team || 'Winner Group A';
      const runnerA = rowsA[1]?.team || 'Runner-up Group A';
      const winnerB = rowsB[0]?.team || 'Winner Group B';
      const runnerB = rowsB[1]?.team || 'Runner-up Group B';

      els.sf1.innerHTML = `
        <div class="text-sm font-medium text-gray-800">${esc(winnerA)}</div>
        <span class="vs-text text-lg">VS</span>
        <div class="text-sm font-medium text-gray-800">${esc(runnerB)}</div>
      `;
      els.sf2.innerHTML = `
        <div class="text-sm font-medium text-gray-800">${esc(winnerB)}</div>
        <span class="vs-text text-lg">VS</span>
        <div class="text-sm font-medium text-gray-800">${esc(runnerA)}</div>
      `;

      const findByStage = (stage) => matches.find(m => (m.data()?.stage || '').toLowerCase() === stage.toLowerCase());

      const sf1Doc = findByStage('Semi Final 1');
      const sf2Doc = findByStage('Semi Final 2');

      const pickWinner = (d)=>{
        if (!d) return null;
        const data = d.data();
        const s = matchScore(data);
        const status = computeStatus(data);
        if (!s || !status || status.text!=='FT') return null;
        if (s.s1===s.s2) return null;
        const t1 = data.teamNames?.team1 || '';
        const t2 = data.teamNames?.team2 || '';
        return s.s1>s.s2 ? t1 : t2;
      };
      const pickLoser = (d)=>{
        if (!d) return null;
        const data = d.data();
        const s = matchScore(data);
        const status = computeStatus(data);
        if (!s || !status || status.text!=='FT') return null;
        if (s.s1===s.s2) return null;
        const t1 = data.teamNames?.team1 || '';
        const t2 = data.teamNames?.team2 || '';
        return s.s1<s.s2 ? t1 : t2;
      };

      const w1 = pickWinner(sf1Doc), w2 = pickWinner(sf2Doc);
      const l1 = pickLoser(sf1Doc),  l2 = pickLoser(sf2Doc);

      els.third.innerHTML = `
        <div class="text-sm font-medium text-gray-800">${esc(l1 || 'Loser Semi Final 1')}</div>
        <span class="vs-text text-lg">VS</span>
        <div class="text-sm font-medium text-gray-800">${esc(l2 || 'Loser Semi Final 2')}</div>
      `;
      els.final.innerHTML = `
        <div class="text-sm font-semibold text-amber-700">${esc(w1 || 'Winner SF1')}</div>
        <span class="vs-text text-xl text-amber-600">VS</span>
        <div class="text-sm font-semibold text-amber-700">${esc(w2 || 'Winner SF2')}</div>
      `;
    }

    // ===== Live wiring
    const qMatches = query(collection(db, 'matches'), orderBy('created','desc'));
    onSnapshot(qMatches, snap => {
      const docs = snap.docs;
      renderMatchList(docs);

      const { table, groupRoster } = buildStandings(docs);
      const rowsA = sortRows(table.A);
      const rowsB = sortRows(table.B);

      renderStandingsCell(els.gaBody, rowsA);
      renderStandingsCell(els.gbBody, rowsB);

      const reqA = requiredMatchesFor(groupRoster.A);
      const reqB = requiredMatchesFor(groupRoster.B);

      const playedA = reqA ? countGroupFT(docs, 'A') : 0;
      const playedB = reqB ? countGroupFT(docs, 'B') : 0;

      const doneA = reqA > 0 && playedA >= reqA;
      const doneB = reqB > 0 && playedB >= reqB;

      els.gaStatus.textContent = reqA ? (doneA ? 'Complete' : `Waiting (${Math.min(playedA, reqA)}/${reqA})`) : 'No teams';
      els.gbStatus.textContent = reqB ? (doneB ? 'Complete' : `Waiting (${Math.min(playedB, reqB)}/${reqB})`) : 'No teams';
      els.standingsMeta.innerHTML = `<span class="badge">Groups detected: A=${groupRoster.A.size || 0}, B=${groupRoster.B.size || 0}</span>`;

      if (doneA && doneB && rowsA.length>=2 && rowsB.length>=2) {
        updateKnockouts(rowsA, rowsB, docs);
        els.knockoutNote.textContent = '';
      } else {
        updateKnockouts([], [], docs);
        els.knockoutNote.textContent = 'Bracket will finalize after all group matches are completed.';
      }
    });
  </script>
</body>
</html>
